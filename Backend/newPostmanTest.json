{
  "info": {
    "name": "üöÄ Plateforme Livraison - Test Complet",
    "description": "Collection compl√®te avec tous les endpoints - Workflow: User ‚Üí Paiement ‚Üí Agent ‚Üí Colis ‚Üí D√©charge",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url_auth",
      "value": "http://localhost:8000",
      "type": "string"
    },
    {
      "key": "base_url_courier",
      "value": "http://localhost:8001",
      "type": "string"
    },
    {
      "key": "base_url_decharge",
      "value": "http://localhost:8002",
      "type": "string"
    },
    {
      "key": "base_url_payment",
      "value": "http://localhost:8003",
      "type": "string"
    },
    {
      "key": "user_email",
      "value": "ilboudojeanbaptiste41@gmail.com",
      "type": "string"
    },
    {
      "key": "agent_email",
      "value": "bobcompteatoutfaire@gmail.com",
      "type": "string"
    },
    {
      "key": "admin_email",
      "value": "ilboudojeanbaptistepro@gmail.com",
      "type": "string"
    },
    {
      "key": "user_password",
      "value": "Password123!",
      "type": "string"
    },
    {
      "key": "agent_password",
      "value": "AgentPass123!",
      "type": "string",
      "description": "G√©n√©r√© automatiquement lors de la cr√©ation"
    },
    {
      "key": "admin_password",
      "value": "AdminPass123!",
      "type": "string"
    },
    {
      "key": "user_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "agent_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "admin_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "user_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "agent_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "colis_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "decharge_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "verification_code",
      "value": "",
      "type": "string"
    },
    {
      "key": "stripe_price_id",
      "value": "price_1SN1wgRv7fgRikcb1hMwmMcQ",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "üîß 1. V√âRIFICATION SERVICES",
      "item": [
        {
          "name": "‚úÖ Health Check Auth",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{base_url_auth}}/health"
          }
        },
        {
          "name": "‚úÖ Health Check Courier",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{base_url_courier}}/health"
          }
        },
        {
          "name": "‚úÖ Health Check Decharge",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{base_url_decharge}}/health"
          }
        },
        {
          "name": "‚úÖ Health Check Payment",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{base_url_payment}}/health"
          }
        }
      ]
    },
    {
      "name": "üîê 2. AUTH - INSCRIPTION USER",
      "item": [
        {
          "name": "üìù Inscription User (Jean Baptiste)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{user_email}}\",\n  \"password\": \"{{user_password}}\",\n  \"name\": \"Jean Baptiste Ilboudo\"\n}"
            },
            "url": "{{base_url_auth}}/api/auth/signup",
            "event": [
              {
                "listen": "test",
                "script": {
                  "exec": [
                    "const response = pm.response.json();",
                    "if (response.success) {",
                    "  pm.collectionVariables.set('user_id', response.data.userId);",
                    "  if (response.data.debug_verification_code) {",
                    "    pm.collectionVariables.set('verification_code', response.data.debug_verification_code);",
                    "    console.log('‚úÖ Code v√©rification:', response.data.debug_verification_code);",
                    "  }",
                    "}"
                  ]
                }
              }
            ]
          }
        },
        {
          "name": "‚úîÔ∏è V√©rifier Email (R√©cup√©rer Code Console)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{user_email}}\",\n  \"providedCode\": \"{{verification_code}}\"\n}"
            },
            "url": "{{base_url_auth}}/api/auth/verify-verification-code",
            "event": [
              {
                "listen": "test",
                "script": {
                  "exec": [
                    "const response = pm.response.json();",
                    "if (response.success && response.token) {",
                    "  pm.collectionVariables.set('user_token', response.token);",
                    "  console.log('‚úÖ User Email v√©rifi√© - Token re√ßu');",
                    "} else {",
                    "  console.log('‚ùå Erreur - V√©rifiez le code de v√©rification');",
                    "}"
                  ]
                }
              }
            ]
          }
        },
        {
          "name": "üîë Connexion User",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{user_email}}\",\n  \"password\": \"{{user_password}}\"\n}"
            },
            "url": "{{base_url_auth}}/api/auth/signin",
            "event": [
              {
                "listen": "test",
                "script": {
                  "exec": [
                    "const response = pm.response.json();",
                    "if (response.success) {",
                    "  pm.collectionVariables.set('user_token', response.data.token);",
                    "  console.log('‚úÖ Connexion r√©ussie - Token:', response.data.token.substring(0, 20) + '...');",
                    "} else {",
                    "  console.log('‚ùå Erreur:', response.message);",
                    "}"
                  ]
                }
              }
            ]
          }
        },
        {
          "name": "üë§ Voir Mon Profil",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{user_token}}"
              }
            ],
            "url": "{{base_url_auth}}/api/auth/getme"
          }
        }
      ]
    },
    {
      "name": "üí≥ 3. PAYMENT - ABONNEMENT",
      "item": [
        {
          "name": "üõí Cr√©er Session Paiement",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{user_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"priceId\": \"{{stripe_price_id}}\"\n}"
            },
            "url": "{{base_url_payment}}/api/subscriptions/checkout-session"
          }
        },
        {
          "name": "‚ö†Ô∏è PAYER SUR STRIPE",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "console.log('‚ö†Ô∏è √âTAPE MANUELLE:');",
                  "console.log('1. Allez sur l\\'URL Stripe re√ßue');",
                  "console.log('2. Utilisez la carte test: 4242 4242 4242 4242');",
                  "console.log('3. Date: 12/25');",
                  "console.log('4. CVC: 123');",
                  "console.log('5. Attendez confirmation paiement');",
                  "console.log('6. V√©rifiez webhook re√ßu (console PaymentService)');"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": "https://checkout.stripe.com"
          }
        },
        {
          "name": "üìä V√©rifier Mon Abonnement",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{user_token}}"
              }
            ],
            "url": "{{base_url_payment}}/api/subscriptions/me"
          }
        }
      ]
    },
    {
      "name": "üë• 4. COURIER - CR√âER AGENT",
      "item": [
        {
          "name": "‚ûï Cr√©er Agent (Apr√®s Paiement)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{user_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"numero\": \"001\",\n  \"nom\": \"Ouedraogo\",\n  \"prenom\": \"Pierre\",\n  \"telephone\": \"+226 70 12 34 56\",\n  \"email\": \"{{agent_email}}\",\n  \"adresse\": \"Ouagadougou, Sector 15\"\n}"
            },
            "url": "{{base_url_courier}}/api/agents",
            "event": [
              {
                "listen": "test",
                "script": {
                  "exec": [
                    "const response = pm.response.json();",
                    "if (response.success) {",
                    "  pm.collectionVariables.set('agent_id', response.data.agentId || response.data._id);",
                    "  console.log('‚úÖ Agent cr√©√© - ID:', response.data.agentId || response.data._id);",
                    "  console.log('üìß Email agent:', pm.collectionVariables.get('agent_email'));",
                    "  console.log('üîë Mot de passe envoy√© par email');",
                    "} else {",
                    "  console.log('‚ùå Erreur:', response.message);",
                    "}"
                  ]
                }
              }
            ]
          }
        },
        {
          "name": "üìã Lister Mes Agents",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{user_token}}"
              }
            ],
            "url": "{{base_url_courier}}/api/agents"
          }
        }
      ]
    },
    {
      "name": "üîë 5. AUTH - CONNEXION AGENT",
      "item": [
        {
          "name": "‚ö†Ô∏è REMPLIR agent_password D'ABORD",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "console.log('‚ö†Ô∏è √âTAPE MANUELLE:');",
                  "console.log('1. V√©rifiez l\\'email de l\\'agent:', pm.collectionVariables.get('agent_email'));",
                  "console.log('2. Copiez le mot de passe re√ßu par email');",
                  "console.log('3. Allez dans Postman ‚Üí Onglet \"Variables\"');",
                  "console.log('4. Remplissez \"agent_password\"');",
                  "console.log('5. Relancez cette requ√™te');"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": "https://example.com"
          }
        },
        {
          "name": "üîë Connexion Agent (Mobile)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "client",
                "value": "not-browser"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{agent_email}}\",\n  \"password\": \"{{agent_password}}\"\n}"
            },
            "url": "{{base_url_auth}}/api/auth/signin",
            "event": [
              {
                "listen": "test",
                "script": {
                  "exec": [
                    "const response = pm.response.json();",
                    "if (response.success) {",
                    "  pm.collectionVariables.set('agent_token', response.data.token);",
                    "  console.log('‚úÖ Agent connect√© - Token re√ßu');",
                    "  console.log('üë§ Role:', response.data.role);",
                    "} else {",
                    "  console.log('‚ùå Erreur:', response.message);",
                    "}"
                  ]
                }
              }
            ]
          }
        }
      ]
    },
    {
      "name": "üì¶ 6. DECHARGE - CR√âER COLIS",
      "item": [
        {
          "name": "‚ûï Cr√©er Colis (User)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{user_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"title\": \"Ordinateur Dell XPS\",\n  \"description\": \"Ordinateur portable neuf √† livrer\",\n  \"referenceNumber\": \"COL-{{$timestamp}}\",\n  \"destination\": \"Ouagadougou, Gounghin\",\n  \"deliveryDate\": \"2025-11-05\"\n}"
            },
            "url": "{{base_url_decharge}}/api/colis",
            "event": [
              {
                "listen": "test",
                "script": {
                  "exec": [
                    "const response = pm.response.json();",
                    "if (response.success) {",
                    "  pm.collectionVariables.set('colis_id', response.data._id);",
                    "  console.log('‚úÖ Colis cr√©√© - ID:', response.data._id);",
                    "} else {",
                    "  console.log('‚ùå Erreur:', response.message);",
                    "}"
                  ]
                }
              }
            ]
          }
        },
        {
          "name": "üìã Lister Mes Colis",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{user_token}}"
              }
            ],
            "url": "{{base_url_decharge}}/api/colis"
          }
        },
        {
          "name": "üìå Assigner Colis √† Agent",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{user_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"agentId\": \"{{agent_id}}\"\n}"
            },
            "url": "{{base_url_decharge}}/api/colis/{{colis_id}}/assign"
          }
        }
      ]
    },
    {
      "name": "üìù 7. DECHARGE - LIVRAISON (AGENT MOBILE)",
      "item": [
        {
          "name": "üìã Lister Colis Assign√©s (Agent)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{agent_token}}"
              },
              {
                "key": "client",
                "value": "not-browser"
              }
            ],
            "url": "{{base_url_decharge}}/api/colis"
          }
        },
        {
          "name": "‚úçÔ∏è Cr√©er D√©charge (Mobile)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{agent_token}}"
              },
              {
                "key": "client",
                "value": "not-browser"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"colisId\": \"{{colis_id}}\",\n  \"nomDestinataire\": \"Marie Kabor√©\",\n  \"fonctionDestinataire\": \"Responsable courrier\",\n  \"telephoneDestinataire\": \"+226 75 11 22 33\",\n  \"adresseLivraison\": \"Ouagadougou, Gounghin\",\n  \"positionLivraison\": {\n    \"latitude\": 12.3714,\n    \"longitude\": -1.5197,\n    \"precision\": 10\n  },\n  \"signature\": \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==\",\n  \"commentaireAgent\": \"Livr√© en main propre, client satisfait\"\n}"
            },
            "url": "{{base_url_decharge}}/api/decharges",
            "event": [
              {
                "listen": "test",
                "script": {
                  "exec": [
                    "const response = pm.response.json();",
                    "if (response.success) {",
                    "  pm.collectionVariables.set('decharge_id', response.data._id);",
                    "  console.log('‚úÖ D√©charge cr√©√©e - ID:', response.data._id);",
                    "  console.log('üìç Position captur√©e: Lat', response.data.positionLivraison.latitude, 'Long', response.data.positionLivraison.longitude);",
                    "} else {",
                    "  console.log('‚ùå Erreur:', response.message);",
                    "}"
                  ]
                }
              }
            ]
          }
        },
        {
          "name": "üìã Lister Mes D√©charges (Agent)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{agent_token}}"
              },
              {
                "key": "client",
                "value": "not-browser"
              }
            ],
            "url": "{{base_url_decharge}}/api/decharges"
          }
        }
      ]
    },
    {
      "name": "‚úÖ 8. V√âRIFICATION FINALE (USER)",
      "item": [
        {
          "name": "üìä Voir Mes Colis Livr√©s",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{user_token}}"
              }
            ],
            "url": "{{base_url_decharge}}/api/colis"
          }
        },
        {
          "name": "üìÑ Voir Mes D√©charges",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{user_token}}"
              }
            ],
            "url": "{{base_url_decharge}}/api/decharges"
          }
        }
      ]
    }
  ]
}
